name: curator_cli test
on:
  workflow_dispatch:
  pull_request:
    branches:
      - master
    paths:
      - 'curator-cli/**'

jobs:
  Test-curator_cli-Package:
    runs-on: windows-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: ðŸ¦º Install validation extension
        run: choco install chocolatey-community-validation.extension -y
      - name: ðŸ“¦ Pack Chocolatey Package
        run: choco pack curator-cli/curator-cli.nuspec
      - name: ðŸ“ Validate Package
        run: choco info curator-cli.nupkg
      - name: ðŸ“¥ Install curator-cli package
        run: choco install curator-cli -y --source "'.;https://community.chocolatey.org/api/v2/'"
      - name: âœ… Find Python 3.10+ installation
        id: find-python
        run: |
          # Search multiple possible Python installation locations
          $searchPaths = @(
              'C:\Python*',
              'C:\hostedtoolcache\windows\Python\*'
          )
          
          $pythonExe = $null
          
          foreach ($searchPath in $searchPaths) {
              $pythonDirs = Get-ChildItem -Path $searchPath -Directory -ErrorAction SilentlyContinue | 
                  Sort-Object Name -Descending
              
              foreach ($dir in $pythonDirs) {
                  $pythonPath = Join-Path $dir.FullName 'python.exe'
                  if ($null -eq $pythonPath) { $pythonPath = Join-Path $dir.FullName 'x64' | Join-Path -ChildPath 'python.exe' }
                  
                  if (Test-Path $pythonPath) {
                      $version = & $pythonPath --version 2>&1
                      if ($version -match 'Python 3\.(\d+)' -and [int]$matches[1] -ge 10) {
                          Write-Host "Found Python 3.10+: $version at $pythonPath"
                          echo "python_exe=$pythonPath" >> $env:GITHUB_OUTPUT
                          exit 0
                      }
                  }
                  
                  # Also check x64 subdirectory
                  $x64Path = Join-Path $dir.FullName 'x64' | Join-Path -ChildPath 'python.exe'
                  if (Test-Path $x64Path) {
                      $version = & $x64Path --version 2>&1
                      if ($version -match 'Python 3\.(\d+)' -and [int]$matches[1] -ge 10) {
                          Write-Host "Found Python 3.10+: $version at $x64Path"
                          echo "python_exe=$x64Path" >> $env:GITHUB_OUTPUT
                          exit 0
                      }
                  }
              }
          }
          Write-Host "ERROR: Python 3.10+ not found in standard locations"
          Write-Host "Searching all subdirectories for python.exe..."
          $foundPython = Get-ChildItem -Path 'C:\' -Recurse -Filter 'python.exe' -ErrorAction SilentlyContinue | 
              Where-Object { $_.FullName -match '3\.1[4-9]|3\.[2-9]\d' } | 
              Select-Object -First 1
          
          if ($foundPython) {
              Write-Host "Found python.exe at: $($foundPython.FullName)"
              $version = & $foundPython.FullName --version 2>&1
              if ($version -match 'Python 3\.(\d+)' -and [int]$matches[1] -ge 10) {
                  echo "python_exe=$($foundPython.FullName)" >> $env:GITHUB_OUTPUT
                  exit 0
              }
          }
          
          Write-Host "ERROR: Python 3.10+ not found anywhere"
          exit 1
      - name: âœ… Verify Python version
        run: ${{ steps.find-python.outputs.python_exe }} --version
      - name: âœ… Verify curator CLI is available
        run: ${{ steps.find-python.outputs.python_exe }} -m pip list | findstr curator
      - name: ðŸ§ª Test curator CLI help command
        run: ${{ steps.find-python.outputs.python_exe }} -m curator --help


